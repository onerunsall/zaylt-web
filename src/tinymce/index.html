<!DOCTYPE html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />

<head>

  <script src="./js/tinymce/tinymce.min.js"></script>
  <script src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>

  <style>
    .submit-btn {
      width: 100%;
      height: 30px;
      border-radius: 10px;
      background: #4a7bd4;
      color: #fff;
      margin-top: 20px;
      border: none;
    }
  </style>
</head>

<body>
  <div id="app">
    <textarea id="tinydemo" v-model="content"></textarea>

    <button class="submit-btn" @click="submit">提交</button>
  </div>
</body>
<script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.9/vue.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
<script>
  function getUploadContent(data) {
    return $.ajax({
      type: "GET",
      url: `https://njshangka.com/ylt/content/${data.no}/${data.name}`,
      data: data || {},
      header: {
        'content-type': 'application/octet-stream',
      },
    })
  }
  function uploadContent(data, no = '') {
    return $.ajax({
      type: "POST",
      url: `https://njshangka.com/ylt/upload-content?no=${no}`,
      data: data || {},
      header: {
        'content-type': 'application/octet-stream',
      },
    })
  }
</script>
<script>
  tinymce.init({
    selector: '#tinydemo',
    language: 'zh_CN',
    height: 600,
  })

  new Vue({
    el: '#app',
    data() {
      return {
        content: '',
        option: {},
        editData: {},
        name: ''
      }
    },
    mounted() {
      this.init()
    },
    methods: {
      async init() {
        this.getparams()
        alert(this.option.contentNo)
        if (this.option.contentNo) {
          let params = {
            no: this.option.contentNo,
            name: this.option.contentNo
          }
          let res2 = await getUploadContent(params)
          this.content = res2
          console.log(this.content)
        }
      },
      // 拿到url参数
      getparams() {
        var url = window.location.search;
        var theRequest = {};
        if (url.indexOf("?") != -1) {
          var str = url.substr(1);
          var strs = str.split("&");
          for (var i = 0; i < strs.length; i++) {
            theRequest[strs[i].split("=")[0]] = (strs[i].split("=")[1]);
          }
          this.option = theRequest
          console.log(this.option)
        }
      },
      async submit() {
        let content = tinyMCE.activeEditor.getContent()
        console.log(content)
        let res = await uploadContent(content, this.option.contentNo)
        console.log(res.data.no)
        wx.miniProgram.postMessage({
          data: {
            content: content,
            contentNo: res
          }
        })
        // wx.miniProgram.postMessage({ data: { foo: 'bar' } })
        wx.miniProgram.navigateBack()
        // wx.miniProgram.navigateTo({
        //   url: this.option.url + '?content=' + content + '&contentNo=' + contentNo
        // })
      }
    },
  })
</script>

</html>